# BookMe ä¸šåŠ¡æµç¨‹å®Œæ•´æ–‡æ¡£

> æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† BookMe P2P é¢„çº¦å¹³å°çš„æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼Œå¹¶æ ‡æ³¨äº†å½“å‰å®ç°ä¸­å‘ç°çš„é—®é¢˜ã€‚
>
> **æœ€åæ›´æ–°**: 2026-01-10

---

## ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#1-ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [ç”¨æˆ·è®¤è¯æµç¨‹](#2-ç”¨æˆ·è®¤è¯æµç¨‹)
3. [æœåŠ¡ç®¡ç†æµç¨‹](#3-æœåŠ¡ç®¡ç†æµç¨‹)
4. [é¢„çº¦æµç¨‹](#4-é¢„çº¦æµç¨‹)
5. [æ”¯ä»˜æµç¨‹](#5-æ”¯ä»˜æµç¨‹)
6. [æ¶ˆæ¯ç³»ç»Ÿ](#6-æ¶ˆæ¯ç³»ç»Ÿ)
7. [è¯„ä»·ç³»ç»Ÿ](#7-è¯„ä»·ç³»ç»Ÿ)
8. [æ—¥å†é›†æˆ](#8-æ—¥å†é›†æˆ)
9. [è‡ªåŠ¨åŒ–ä»»åŠ¡ (Cron Jobs)](#9-è‡ªåŠ¨åŒ–ä»»åŠ¡-cron-jobs)
10. [å·²å‘ç°é—®é¢˜æ¸…å•](#10-å·²å‘ç°é—®é¢˜æ¸…å•)
11. [å»ºè®®æ”¹è¿›é¡¹](#11-å»ºè®®æ”¹è¿›é¡¹)

---

## 1. ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 1.1 æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ |
|------|------|
| å‰ç«¯ | Vite + React + TypeScript |
| åç«¯ | Hono (Node.js) |
| æ•°æ®åº“ | Railway PostgreSQL |
| å­˜å‚¨ | Cloudflare R2 (S3 å…¼å®¹) |
| è®¤è¯ | Privy (æ”¯æŒé‚®ç®±ã€ç¤¾äº¤è´¦å·ã€é’±åŒ…) |
| åŒºå—é“¾ | Base Sepolia (æ™ºèƒ½åˆçº¦) |
| å®æ—¶é€šä¿¡ | WebSocket (Socket.io) + PostgreSQL NOTIFY/LISTEN |

### 1.2 æ ¸å¿ƒç›®å½•ç»“æ„

```
bookme/
â”œâ”€â”€ src/                    # å‰ç«¯æºç 
â”‚   â”œâ”€â”€ contexts/           # React Context (è®¤è¯ç­‰)
â”‚   â”œâ”€â”€ lib/               # API å®¢æˆ·ç«¯ã€å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ pages/             # é¡µé¢ç»„ä»¶
â”‚   â””â”€â”€ components/        # UI ç»„ä»¶
â”œâ”€â”€ backend/               # åç«¯æœåŠ¡
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ routes/        # API è·¯ç”±
â”‚       â”œâ”€â”€ services/      # ä¸šåŠ¡æœåŠ¡
â”‚       â””â”€â”€ middleware/    # ä¸­é—´ä»¶
â”œâ”€â”€ backend-cron/          # å®šæ—¶ä»»åŠ¡æœåŠ¡
â”œâ”€â”€ database/              # æ•°æ®åº“è¿ç§»è„šæœ¬
â””â”€â”€ admin-cli/             # ç®¡ç†å‘˜ CLI å·¥å…·
```

---

## 2. ç”¨æˆ·è®¤è¯æµç¨‹

### 2.1 è®¤è¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend   â”‚â”€â”€â”€â”€â”€â”€â”‚    Privy     â”‚â”€â”€â”€â”€â”€â”€â”‚   Backend    â”‚
â”‚  (React)     â”‚      â”‚  (Auth SDK)  â”‚      â”‚   (Hono)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚                     â”‚
       â”‚  1. ç”¨æˆ·ç™»å½•         â”‚                     â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚
       â”‚                     â”‚                     â”‚
       â”‚  2. è¿”å› DID + Tokenâ”‚                     â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚
       â”‚                     â”‚                     â”‚
       â”‚  3. API è¯·æ±‚ (Bearer Token)               â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                     â”‚                     â”‚
       â”‚                     â”‚  4. éªŒè¯ Token      â”‚
       â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                     â”‚                     â”‚
       â”‚  5. è¿”å›ä¸šåŠ¡æ•°æ®                          â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### 2.2 ID æ˜ å°„æœºåˆ¶

Privy è¿”å›çš„ç”¨æˆ· ID æ ¼å¼ä¸º DID (`did:privy:xxxxx`)ï¼Œéœ€è¦è½¬æ¢ä¸ºæ•°æ®åº“ä½¿ç”¨çš„ UUID æ ¼å¼ã€‚

**æ ¸å¿ƒæ–‡ä»¶**: `src/lib/id-mapping.ts`, `backend/src/middleware/auth.js`

```javascript
// UUID v5 å‘½åç©ºé—´
const PRIVY_NAMESPACE = '6ba7b810-9dad-11d1-80b4-00c04fd430c8';

function privyDidToUuid(privyDid) {
  return uuidv5(privyDid, PRIVY_NAMESPACE);
}
```

### 2.3 ç”¨æˆ·èµ„æ–™åŒæ­¥

é¦–æ¬¡ç™»å½•æ—¶é€šè¿‡ `/api/auth/login` æ‰§è¡Œ upsert æ“ä½œï¼š
- æ–°ç”¨æˆ·ï¼šåˆ›å»ºç”¨æˆ·è®°å½•
- ç°æœ‰ç”¨æˆ·ï¼šæ›´æ–° `last_sign_in_at`

### 2.4 é’±åŒ…åœ°å€åŒæ­¥

æ¯æ¬¡è®¤è¯è¯·æ±‚æ—¶ï¼Œä¸­é—´ä»¶ä¼šè‡ªåŠ¨åŒæ­¥ç”¨æˆ·çš„ Smart Wallet åœ°å€åˆ°æ•°æ®åº“ã€‚

**æŸ¥æ‰¾ä¼˜å…ˆçº§**:
1. Smart Wallet åœ°å€
2. Embedded Wallet åœ°å€

---

## 3. æœåŠ¡ç®¡ç†æµç¨‹

### 3.1 æœåŠ¡æ•°æ®æ¨¡å‹

| å­—æ®µ | ç±»å‹ | æè¿° |
|------|------|------|
| `title` | TEXT | æœåŠ¡æ ‡é¢˜ |
| `description` | TEXT | æœåŠ¡æè¿° |
| `price` | DECIMAL | ä»·æ ¼ (USDC) |
| `duration_minutes` | INT | æœåŠ¡æ—¶é•¿ |
| `is_online` | BOOLEAN | æ˜¯å¦åœ¨çº¿æœåŠ¡ |
| `location` | TEXT | çº¿ä¸‹æœåŠ¡åœ°ç‚¹ |
| `availability_schedule` | JSONB | å¯ç”¨æ—¶é—´è¡¨ |
| `is_visible` | BOOLEAN | æœåŠ¡å¯è§æ€§ |
| `meeting_platform` | TEXT | ä¼šè®®å¹³å° |
| `images` | TEXT[] | æœåŠ¡å›¾ç‰‡ (R2 URL) |

### 3.2 å¯ç”¨æ€§æ—¶é—´è¡¨ç»“æ„

```json
{
  "monday": [
    { "start": "09:00", "end": "12:00" },
    { "start": "14:00", "end": "18:00" }
  ],
  "tuesday": [
    { "start": "09:00", "end": "17:00" }
  ]
  // ...å…¶ä»–æ—¥æœŸ
}
```

### 3.3 å¯ç”¨æ€§è®¡ç®—æµç¨‹

```
1. è·å–æœåŠ¡çš„ availability_schedule
2. è·å–å·²æœ‰é¢„çº¦ï¼Œæ’é™¤å ç”¨æ—¶æ®µ
3. è·å– Google Calendar äº‹ä»¶ (å¦‚å·²é›†æˆ)
4. è®¡ç®—å¯ç”¨æ—¶é—´æ§½ (è€ƒè™‘æœåŠ¡æ—¶é•¿)
5. è¿”å›å¯é¢„çº¦æ—¶é—´åˆ—è¡¨
```

**æ ¸å¿ƒæ–‡ä»¶**: `backend/src/services/availability-service.js`

---

## 4. é¢„çº¦æµç¨‹

### 4.1 é¢„çº¦çŠ¶æ€æµè½¬å›¾

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  cancelled  â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â–²
                                          â”‚ (ä»»æ„çŠ¶æ€å¯å–æ¶ˆ)
                                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   pending    â”‚â”€â”€â”€>â”‚  pending_payment â”‚â”€â”€â”¼â”€>â”‚    paid      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚              â”‚         â”‚
                           â”‚ (3åˆ†é’Ÿè¶…æ—¶)   â”‚         â”‚ (Provider ç¡®è®¤)
                           â–¼              â”‚         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   expired    â”‚      â”‚  â”‚  confirmed   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚         â”‚
                                          â”‚         â”‚ (åˆ°è¾¾æœåŠ¡æ—¶é—´)
                                          â”‚         â–¼
                                          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â””â”€â”€â”‚ in_progress  â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â”‚ (Customer ç¡®è®¤å®Œæˆ)
                                                    â–¼
                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                             â”‚  completed   â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 é¢„çº¦åˆ›å»ºæµç¨‹

**API**: `POST /api/bookings`

```
1. éªŒè¯ç”¨æˆ·è®¤è¯
2. è·å–æœåŠ¡è¯¦æƒ…
3. éªŒè¯ï¼š
   - ä¸èƒ½é¢„çº¦è‡ªå·±çš„æœåŠ¡
   - æ—¶é—´æ§½å¯ç”¨æ€§æ£€æŸ¥
   - æ—¶é—´ä¸èƒ½æ˜¯è¿‡å»
4. åˆ›å»ºé¢„çº¦è®°å½• (status: pending)
5. ç”Ÿæˆ EIP-712 æ”¯ä»˜æˆæƒç­¾å
6. æ›´æ–°é¢„çº¦çŠ¶æ€ä¸º pending_payment
7. å­˜å‚¨ç­¾å nonce (é˜²é‡æ”¾æ”»å‡»)
8. åˆ›å»ºå¯¹è¯è®°å½• (customer â†” provider)
9. è¿”å›é¢„çº¦ä¿¡æ¯ + æ”¯ä»˜æˆæƒ
```

### 4.3 å†²çªæ£€æµ‹é€»è¾‘

```javascript
// æ£€æŸ¥æ—¶é—´é‡å 
const hasConflict = conflictingBookings?.some((booking) => {
  const existingStart = new Date(booking.scheduled_at);
  const existingEnd = new Date(
    existingStart.getTime() + booking.duration_minutes * 60000
  );
  return bookingStart < existingEnd && bookingEnd > existingStart;
});
```

### 4.4 å–æ¶ˆç­–ç•¥

**æ ¸å¿ƒæ–‡ä»¶**: `backend/src/cancellation-policies.js`

| ç­–ç•¥ç±»å‹ | é€€æ¬¾æ¯”ä¾‹ | è¯´æ˜ |
|----------|----------|------|
| PROVIDER_REJECT | 100% | Provider æ‹’ç»é¢„çº¦ |
| CUSTOMER_NORMAL | 85% | æ­£å¸¸å–æ¶ˆ |
| CUSTOMER_EMERGENCY | 90% | ç´§æ€¥å–æ¶ˆ |
| PROVIDER_INITIATED | 100% | Provider å‘èµ·å–æ¶ˆ |

---

## 5. æ”¯ä»˜æµç¨‹

### 5.1 åŒºå—é“¾æ”¯ä»˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend â”‚â”€â”€â”€â”€>â”‚ Backend  â”‚â”€â”€â”€â”€>â”‚ Smart        â”‚â”€â”€â”€â”€>â”‚ Event        â”‚
â”‚          â”‚     â”‚ (Sign)   â”‚     â”‚ Contract     â”‚     â”‚ Monitor      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                  â”‚                    â”‚
     â”‚ 1. åˆ›å»ºé¢„çº¦    â”‚                  â”‚                    â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                    â”‚
     â”‚                â”‚                  â”‚                    â”‚
     â”‚ 2. EIP-712 ç­¾åâ”‚                  â”‚                    â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                    â”‚
     â”‚                â”‚                  â”‚                    â”‚
     â”‚ 3. å‘é€äº¤æ˜“ (USDC + createAndPayBooking)              â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
     â”‚                â”‚                  â”‚                    â”‚
     â”‚                â”‚                  â”‚ 4. è§¦å‘äº‹ä»¶        â”‚
     â”‚                â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                â”‚                  â”‚                    â”‚
     â”‚                â”‚                  â”‚    5. æ›´æ–°æ•°æ®åº“   â”‚
     â”‚                â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### 5.2 EIP-712 ç­¾åç»“æ„

**æ ¸å¿ƒæ–‡ä»¶**: `backend/src/eip712-signer.js`

```javascript
const types = {
  PaymentAuthorization: [
    { name: 'bookingId', type: 'bytes32' },     // UUID çš„ keccak256 å“ˆå¸Œ
    { name: 'customer', type: 'address' },       // å®¢æˆ·é’±åŒ…åœ°å€
    { name: 'provider', type: 'address' },       // æœåŠ¡æä¾›è€…é’±åŒ…åœ°å€
    { name: 'inviter', type: 'address' },        // é‚€è¯·äººåœ°å€ (å¯é€‰)
    { name: 'amount', type: 'uint256' },         // æ”¯ä»˜é‡‘é¢ (USDC)
    { name: 'platformFeeRate', type: 'uint256' },// å¹³å°è´¹ç‡ (10%)
    { name: 'inviterFeeRate', type: 'uint256' }, // é‚€è¯·äººè´¹ç‡
    { name: 'expiry', type: 'uint256' },         // ç­¾åè¿‡æœŸæ—¶é—´
    { name: 'nonce', type: 'uint256' }           // é˜²é‡æ”¾ nonce
  ]
};
```

### 5.3 è´¹ç”¨åˆ†é…

| è§’è‰² | æ¯”ä¾‹ | è¯´æ˜ |
|------|------|------|
| Provider | 90% | æœåŠ¡æä¾›è€…æ”¶å…¥ |
| Platform | 10% | å¹³å°æ‰‹ç»­è´¹ |
| Inviter | 0-5% | é‚€è¯·äººå¥–åŠ± (ä»å¹³å°è´¹ä¸­æ‰£é™¤) |

### 5.4 æ™ºèƒ½åˆçº¦ä¿¡æ¯

| å±æ€§ | å€¼ |
|------|-----|
| ç½‘ç»œ | Base Sepolia (æµ‹è¯•ç½‘) |
| åˆçº¦åœ°å€ | `0x33ddEd6F8183aa4dAB04E2aE216a5a3f9871405a` |
| USDC åœ°å€ | `0x036CbD53842c5426634e7929541eC2318f3dCF7e` |

---

## 6. æ¶ˆæ¯ç³»ç»Ÿ

### 6.1 æ•°æ®æ¨¡å‹

**conversations è¡¨**:
| å­—æ®µ | æè¿° |
|------|------|
| `user1_id` | ç”¨æˆ· 1 ID |
| `user2_id` | ç”¨æˆ· 2 ID |
| `last_message_at` | æœ€åæ¶ˆæ¯æ—¶é—´ |

**messages è¡¨**:
| å­—æ®µ | æè¿° |
|------|------|
| `conversation_id` | å¯¹è¯ ID |
| `sender_id` | å‘é€è€… ID |
| `content` | æ¶ˆæ¯å†…å®¹ |
| `is_read` | æ˜¯å¦å·²è¯» |

### 6.2 å®æ—¶æ¶ˆæ¯æµç¨‹

```
1. ç”¨æˆ·å‘é€æ¶ˆæ¯
2. Backend ä¿å­˜åˆ° messages è¡¨
3. PostgreSQL è§¦å‘ NOTIFY 'new_message'
4. WebSocket æœåŠ¡ç›‘å¬ LISTEN 'new_message'
5. å¹¿æ’­åˆ°ç›¸å…³ç”¨æˆ·çš„ Socket æˆ¿é—´
6. å‰ç«¯æ”¶åˆ°å®æ—¶æ¶ˆæ¯æ›´æ–°
```

**æ ¸å¿ƒæ–‡ä»¶**: `backend/src/websocket.js`, `backend/src/routes/conversations.js`

---

## 7. è¯„ä»·ç³»ç»Ÿ

### 7.1 è¯„ä»·è§„åˆ™

| è§„åˆ™ | æè¿° |
|------|------|
| è¯„ä»·æ¡ä»¶ | ä»… `completed` çŠ¶æ€çš„é¢„çº¦å¯è¯„ä»· |
| è¯„ä»·è€… | ä»… Customer å¯è¯„ä»· Provider |
| å”¯ä¸€æ€§ | æ¯ä¸ªé¢„çº¦åªèƒ½è¯„ä»·ä¸€æ¬¡ |
| è¯„ä»·çª—å£ | å®Œæˆå 30 å¤©å†…å¯æäº¤ |
| è¯„åˆ†èŒƒå›´ | 1-5 æ˜Ÿ |

### 7.2 è¯„åˆ†æ›´æ–°æµç¨‹

```
1. Customer æäº¤è¯„ä»· (POST /api/reviews)
2. éªŒè¯é¢„çº¦çŠ¶æ€å’Œè¯„ä»·èµ„æ ¼
3. åˆ›å»ºè¯„ä»·è®°å½•
4. å¼‚æ­¥æ›´æ–° Provider çš„å¹³å‡è¯„åˆ†
   - æŸ¥è¯¢æ‰€æœ‰è¯„ä»·
   - è®¡ç®—å¹³å‡åˆ†
   - æ›´æ–° users è¡¨çš„ rating å’Œ review_count
```

**æ ¸å¿ƒæ–‡ä»¶**: `backend/src/routes/reviews.js`

---

## 8. æ—¥å†é›†æˆ

### 8.1 Google Meet é›†æˆæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Provider â”‚â”€â”€â”€â”€>â”‚ Backend  â”‚â”€â”€â”€â”€>â”‚   Google     â”‚â”€â”€â”€â”€>â”‚  Database    â”‚
â”‚          â”‚     â”‚ (OAuth)  â”‚     â”‚   OAuth      â”‚     â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                  â”‚                    â”‚
     â”‚ 1. å‘èµ·æˆæƒ    â”‚                  â”‚                    â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                    â”‚
     â”‚                â”‚                  â”‚                    â”‚
     â”‚ 2. é‡å®šå‘åˆ° Google                â”‚                    â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                    â”‚
     â”‚                â”‚                  â”‚                    â”‚
     â”‚ 3. ç”¨æˆ·æˆæƒåå›è°ƒ                 â”‚                    â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
     â”‚                â”‚                  â”‚                    â”‚
     â”‚                â”‚ 4. è·å– Token    â”‚                    â”‚
     â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
     â”‚                â”‚                  â”‚                    â”‚
     â”‚                â”‚                  â”‚    5. å­˜å‚¨ Token   â”‚
     â”‚                â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
```

### 8.2 ä¼šè®®é“¾æ¥ç”Ÿæˆæ—¶æœº

1. é¢„çº¦ç¡®è®¤æ—¶ (`status: confirmed`)
2. æœåŠ¡å¼€å§‹æ—¶ (`status: in_progress`) - ä½œä¸ºå¤‡ç”¨

### 8.3 Token åˆ·æ–°æœºåˆ¶

- æ£€æµ‹ Token è¿‡æœŸ (5åˆ†é’Ÿç¼“å†²)
- ä½¿ç”¨ refresh_token è·å–æ–° access_token
- åˆ·æ–°å¤±è´¥åˆ™åœç”¨é›†æˆ (`is_active: false`)
- 6ä¸ªæœˆæœªä½¿ç”¨çš„é›†æˆè‡ªåŠ¨åœç”¨

**æ ¸å¿ƒæ–‡ä»¶**: `backend/src/services/calendar-service.js`, `backend/src/meeting-generation.js`

---

## 9. è‡ªåŠ¨åŒ–ä»»åŠ¡ (Cron Jobs)

### 9.1 ä»»åŠ¡è°ƒåº¦

**è¿è¡Œé¢‘ç‡**: æ¯ 15 åˆ†é’Ÿ (Railway Cron)

**æ ¸å¿ƒæ–‡ä»¶**: `backend-cron/src/index.js`, `backend-cron/src/booking-automation.js`

### 9.2 è‡ªåŠ¨åŒ–ä»»åŠ¡åˆ—è¡¨

| ä»»åŠ¡ | æè¿° | çŠ¶æ€ |
|------|------|------|
| `transitionConfirmedToInProgress` | åˆ°è¾¾æœåŠ¡æ—¶é—´æ—¶è‡ªåŠ¨å¼€å§‹ | âœ… å·²å®ç° |
| `transitionInProgressToCompleted` | æœåŠ¡ç»“æŸ 30 åˆ†é’Ÿåè‡ªåŠ¨å®Œæˆ | âœ… å·²å®ç° |
| `sendUpcomingReminders` | å‘é€é¢„çº¦æé†’ | âš ï¸ å ä½å®ç° |
| `cleanupExpiredPendingPayments` | æ¸…ç†è¿‡æœŸçš„å¾…æ”¯ä»˜é¢„çº¦ | âŒ æœªå®ç° |

### 9.3 è‡ªåŠ¨å®Œæˆä¿æŠ¤æœºåˆ¶

- æ£€æŸ¥ `auto_complete_blocked` æ ‡å¿—
- Google Meet ä¼šè¯æ—¶é•¿éªŒè¯
- å¦‚æœ Provider ä¼šè¯æ—¶é•¿ä¸è¶³ 90%ï¼Œé˜»æ­¢è‡ªåŠ¨å®Œæˆ

---

## 10. å·²å‘ç°é—®é¢˜æ¸…å•

### 10.1 å®‰å…¨é—®é¢˜

| ä¸¥é‡ç¨‹åº¦ | é—®é¢˜ | ä½ç½® | çŠ¶æ€ |
|----------|------|------|------|
| ~~ğŸ”´ é«˜~~ | ~~ä½¿ç”¨ VITE_ å‰ç¼€çš„æ•æ„Ÿå˜é‡~~ | ~~`calendar-service.js:238-239`~~ | âœ… å·²ä¿®å¤ (2026-01-10) |
| ğŸŸ¡ ä¸­ | åŒºå—é“¾äº‹ä»¶ç›‘æ§é»˜è®¤ç¦ç”¨ | `.env` | ç”Ÿäº§ç¯å¢ƒå¯ç”¨ `ENABLE_BLOCKCHAIN_MONITORING=true` |
| ğŸŸ¡ ä¸­ | ç¼ºå°‘ API è¯·æ±‚é¢‘ç‡é™åˆ¶ | å¤šä¸ª API è·¯ç”± | æ·»åŠ  rate limiting ä¸­é—´ä»¶ |

### 10.2 æ•°æ®ä¸€è‡´æ€§é—®é¢˜

| ä¸¥é‡ç¨‹åº¦ | é—®é¢˜ | å½±å“ | çŠ¶æ€ |
|----------|------|------|------|
| ~~ğŸ”´ é«˜~~ | ~~é¢„çº¦å†²çªæ£€æµ‹éåŸå­æ“ä½œ~~ | ~~é«˜å¹¶å‘ä¸‹å¯èƒ½é‡å¤é¢„çº¦~~ | âœ… å·²ä¿®å¤ (2026-01-10) - ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ + FOR UPDATE è¡Œçº§é” |
| ğŸŸ¡ ä¸­ | æ”¯ä»˜ç¡®è®¤å¯èƒ½ä¸¢å¤± | ç›‘æ§æœåŠ¡å®•æœºæ—¶æ”¯ä»˜æˆåŠŸä½†æ•°æ®åº“æœªæ›´æ–° | æ·»åŠ å®šæœŸåŒºå—é“¾çŠ¶æ€åŒæ­¥ä»»åŠ¡ |
| ğŸŸ¡ ä¸­ | æ¶ˆæ¯å·²è¯»çŠ¶æ€å¼‚æ­¥æ›´æ–°å¯èƒ½å¤±è´¥ | æœªè¯»è®¡æ•°ä¸å‡†ç¡® | æ·»åŠ é‡è¯•æœºåˆ¶ |

### 10.3 ç¼ºå¤±åŠŸèƒ½

| ä¼˜å…ˆçº§ | åŠŸèƒ½ | è¯´æ˜ |
|--------|------|------|
| ğŸ”´ é«˜ | è¿‡æœŸå¾…æ”¯ä»˜é¢„çº¦æ¸…ç† | `pending_payment` çŠ¶æ€çš„é¢„çº¦é•¿æœŸä¸æ”¯ä»˜éœ€è¦æ¸…ç† |
| ğŸŸ¡ ä¸­ | è¯„ä»·ç¼–è¾‘/åˆ é™¤ | å½“å‰åªæ”¯æŒåˆ›å»º |
| ğŸŸ¡ ä¸­ | Provider è¯„ä»· Customer | åªæ”¯æŒå•å‘è¯„ä»· |
| ğŸŸ¡ ä¸­ | æ¨é€é€šçŸ¥ | è¯„ä»·ã€æ¶ˆæ¯ç­‰ç¼ºå°‘æ¨é€é€šçŸ¥ |
| ğŸŸ¢ ä½ | å–æ¶ˆé¢„çº¦æ—¶åˆ é™¤ Google Calendar äº‹ä»¶ | å½“å‰åªæ¸…é™¤ meeting_link |

### 10.4 æ–‡æ¡£ä¸å®ç°ä¸ä¸€è‡´

| æ–‡æ¡£æè¿° | å®é™…å®ç° |
|----------|----------|
| 7 å¤©è¯„ä»·ç¼–è¾‘çª—å£ | 30 å¤©æäº¤çª—å£ï¼Œæ— ç¼–è¾‘åŠŸèƒ½ |
| Supabase æ•°æ®åº“ | å·²è¿ç§»åˆ° Railway PostgreSQL |

### 10.5 æ€§èƒ½é—®é¢˜

| é—®é¢˜ | ä½ç½® | çŠ¶æ€ |
|------|------|------|
| ~~N+1 æŸ¥è¯¢~~ | ~~å¯¹è¯åˆ—è¡¨è·å–ç”¨æˆ·ä¿¡æ¯~~ | âœ… å·²ä¿®å¤ (2026-01-10) - ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ + Map ç¼“å­˜ |
| æœªè¯»æ¶ˆæ¯è®¡æ•°æ•ˆç‡ä½ | å‰ç«¯éå†æ‰€æœ‰å¯¹è¯å’Œæ¶ˆæ¯ | åç«¯å®ç°å•ä¸€æŸ¥è¯¢ |

---

## 11. å»ºè®®æ”¹è¿›é¡¹

### 11.1 çŸ­æœŸæ”¹è¿› (ç«‹å³)

1. ~~**ä¿®å¤å®‰å…¨é—®é¢˜**~~ âœ… å·²å®Œæˆ
   - ~~å°† `calendar-service.js` ä¸­çš„ `VITE_GOOGLE_CLIENT_ID` æ”¹ä¸º `GOOGLE_CLIENT_ID`~~
   - ~~å°† `VITE_GOOGLE_CLIENT_SECRET` æ”¹ä¸º `GOOGLE_CLIENT_SECRET`~~

2. **æ·»åŠ è¿‡æœŸé¢„çº¦æ¸…ç†ä»»åŠ¡**
   ```javascript
   // æ·»åŠ åˆ° booking-automation.js
   async function cleanupExpiredPendingPayments() {
     const threeMinutesAgo = new Date(Date.now() - 3 * 60 * 1000);
     await supabaseAdmin
       .from('bookings')
       .update({ status: 'expired' })
       .eq('status', 'pending_payment')
       .lt('created_at', threeMinutesAgo.toISOString());
   }
   ```

3. **å¯ç”¨åŒºå—é“¾ç›‘æ§**
   - ç”Ÿäº§ç¯å¢ƒè®¾ç½® `ENABLE_BLOCKCHAIN_MONITORING=true`

### 11.2 ä¸­æœŸæ”¹è¿› (1-2 å‘¨)

1. **æ·»åŠ æ•°æ®åº“äº‹åŠ¡**
   - é¢„çº¦åˆ›å»ºä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŸå­æ€§
   - æ”¯ä»˜ç¡®è®¤ä½¿ç”¨äº‹åŠ¡

2. **æ·»åŠ  API é€Ÿç‡é™åˆ¶**
   ```javascript
   import { rateLimit } from 'hono-rate-limit';
   app.use('/api/*', rateLimit({ max: 100, windowMs: 60000 }));
   ```

3. **å®ç°åŒºå—é“¾çŠ¶æ€åŒæ­¥**
   - å®šæœŸæŸ¥è¯¢åŒºå—é“¾ç¡®è®¤æ”¯ä»˜çŠ¶æ€
   - å¤„ç†ç›‘æ§æœåŠ¡é—æ¼çš„äº‹ä»¶

### 11.3 é•¿æœŸæ”¹è¿› (1 ä¸ªæœˆ+)

1. **å®ç°å®Œæ•´çš„é€šçŸ¥ç³»ç»Ÿ**
   - é‚®ä»¶é€šçŸ¥
   - æ¨é€é€šçŸ¥
   - SMS é€šçŸ¥ (å¯é€‰)

2. **æ·»åŠ å®¡è®¡æ—¥å¿—**
   - å…³é”®æ“ä½œè®°å½•
   - åŒºå—é“¾äº‹ä»¶è¿½è¸ª

3. **å¼•å…¥ç¼“å­˜å±‚**
   - Redis ç¼“å­˜é«˜é¢‘è®¿é—®æ•°æ®
   - å‡å°‘æ•°æ®åº“å‹åŠ›

4. **åŒå‘è¯„ä»·ç³»ç»Ÿ**
   - Provider å¯ä»¥è¯„ä»· Customer
   - å®Œå–„è¯„ä»·ç¼–è¾‘/åˆ é™¤åŠŸèƒ½

---

## é™„å½•

### A. å…³é”® API ç«¯ç‚¹

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| POST | `/api/auth/login` | ç”¨æˆ·ç™»å½•/æ³¨å†Œ |
| GET | `/api/services` | è·å–æœåŠ¡åˆ—è¡¨ |
| POST | `/api/services` | åˆ›å»ºæœåŠ¡ |
| POST | `/api/bookings` | åˆ›å»ºé¢„çº¦ |
| PATCH | `/api/bookings/:id` | æ›´æ–°é¢„çº¦çŠ¶æ€ |
| POST | `/api/bookings/:id/authorize-payment` | ç”Ÿæˆæ”¯ä»˜æˆæƒ |
| POST | `/api/bookings/:id/complete-service` | å®ŒæˆæœåŠ¡ |
| POST | `/api/reviews` | åˆ›å»ºè¯„ä»· |
| GET | `/api/conversations` | è·å–å¯¹è¯åˆ—è¡¨ |
| POST | `/api/messages` | å‘é€æ¶ˆæ¯ |

### B. æ•°æ®åº“è¡¨å…³ç³»

```
users
  â”œâ”€â”€ services (1:N) - provider_id
  â”œâ”€â”€ bookings (1:N) - customer_id, provider_id
  â”œâ”€â”€ reviews (1:N) - reviewer_id, reviewee_id
  â”œâ”€â”€ conversations (1:N) - user1_id, user2_id
  â””â”€â”€ user_meeting_integrations (1:N) - user_id

services
  â””â”€â”€ bookings (1:N) - service_id

bookings
  â”œâ”€â”€ reviews (1:1) - booking_id
  â”œâ”€â”€ messages (context only)
  â””â”€â”€ blockchain_events (1:N) - booking_id

conversations
  â””â”€â”€ messages (1:N) - conversation_id
```

### C. ç¯å¢ƒå˜é‡æ¸…å•

**Frontend (.env.local)**:
- `VITE_PRIVY_APP_ID`
- `VITE_GOOGLE_CLIENT_ID`
- `VITE_BACKEND_URL`
- `VITE_CONTRACT_ADDRESS`
- `VITE_USDC_ADDRESS`
- `VITE_CHAIN_ID`

**Backend (.env)**:
- `DATABASE_URL`
- `R2_ENDPOINT`, `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY`
- `PRIVY_APP_ID`, `PRIVY_APP_SECRET`
- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`
- `CONTRACT_ADDRESS`, `USDC_ADDRESS`
- `BACKEND_SIGNER_PRIVATE_KEY`
- `ENABLE_BLOCKCHAIN_MONITORING`
